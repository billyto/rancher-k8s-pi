#cloud-config
# This is the user-data configuration file for cloud-init. By default this sets
# up an initial user called "ubuntu" with password "ubuntu", which must be
# changed at first login. However, many additional actions can be initiated on
# first boot from this file. The cloud-init documentation has more details:
#
# Some additional examples are provided in comments below the default
# configuration.
# Enable password authentication with the SSH daemon
ssh_pwauth: true
package_update: true
package_upgrade: true
mounts:
  - [ 192.168.10.11:/pool/home-configs/www/venus/pi-config, /pi-files, nfs, defaults,"0","0" ]
#hostname: changeme
## Add users and groups to the system, and import keys with the ssh-import-id
## utility
groups:
- ubuntu
- mfrank
## Update apt database and upgrade packages on first boot
#package_update: true
#package_upgrade: true
## Install additional packages on first boot
#packages:
#- pwgen
#- pastebinit
#- [libpython2.7, 2.7.3-0ubuntu3.1]
## Write arbitrary files to the file-system (including binaries!)
write_files:
- path: /boot/firmware/cmdline.txt
  permissions: '0764'
  content: |
    net.ifnames=0 dwc_otg.lpm_enable=0 console=serial0,115200 console=tty1 root=LABEL=writable rootfstype=ext4 elevator=deadline rootwait fixrtc quiet splash cgroup_enable=cpuset cgroup_enable=memory cgroup_memory=1 swapaccount=1 ipv6.disable=1
#write_files:
#- path: /etc/default/keyboard
#  content: |
#    # KEYBOARD configuration file
#    # Consult the keyboard(5) manual page.
#    XKBMODEL="pc105"
#    XKBLAYOUT="gb"
#    XKBVARIANT=""
#    XKBOPTIONS="ctrl: nocaps"
#  permissions: '0644'
#  owner: root:root
#- encoding: gzip
#  path: /usr/bin/hello
#  content: !!binary |
#    H4sIAIDb/U8C/1NW1E/KzNMvzuBKTc7IV8hIzcnJVyjPL8pJ4QIA6N+MVxsAAAA=
#  owner: root:root
#  permissions: '0755'
## Run arbitrary commands at rc.local like time
#runcmd:
#- [ ls, -l, / ]
#- [ sh, -xc, "echo $(date) ': hello world!'" ]
#- [ wget, "http://ubuntu.com", -O, /run/mydir/index.html ]
#cloud-config
# This is the user-data configuration file for cloud-init. By default this sets
# up an initial user called "ubuntu" with password "ubuntu", which must be
# changed at first login. However, many additional actions can be initiated on
# first boot from this file. The cloud-init documentation has more details:
#
# https://cloudinit.readthedocs.io/
#
packages:
- ntpdate
- apt-transport-https
- ca-certificates
- curl
- gnupg
- lsb-release
- open-iscsi
- tgt
- nfs-kernel-server
- nfs-common
- net-tools
- iperf
- iperf3
- iftop
bootcmd:
  - mkdir -p /pi-files
runcmd:
- [ /usr/sbin/ntpdate, pool.ntp.org ]
- mount -a
- /pi-files/pi-set-hostname.sh
- curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
- echo "deb [arch=arm64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
- sudo apt-get update -y
- sudo apt-get install -y docker-ce docker-ce-cli containerd.io
- systemctl start docker
- systemctl enable docker
- iscsiadm --mode discovery --op update --type sendtargets --portal 192.168.10.11
- usermod -a -G docker mfrank
- diff /pi-files/user-data /boot/firmware/user-data || cp /pi-files/user-data /boot/firmware/user-data
ssh_pwauth: true
groups:
- mfrank: [mfrank]
- ubuntu: [ubuntu]
users:
- name: ubuntu
  gecos: Michael Frank
  primary_group: mfrank
  shell: /bin/bash
  sudo: ALL=(ALL) NOPASSWD:ALL
  groups: adm, dialout, cdrom, floppy, sudo, audio, dip, video, plugdev, netdev, lxd
  chpasswd: {expire: False}
  lock_passwd: false
  passwd: $6$rounds=4096$tBp/nksZ$9L5H/OAVhPKpeYBe4nEAIak1pxS/lik0GelMMTaIj8fvpvP/04ft.pNodOJ4IvK3DteN/npXO5AX00QBlmGpt1
  ssh_import_id: None
  ssh_pwauth: true
  ssh_authorized_keys:
    - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCdpdysJeBIVxdWFTmH7VsHAD8MYY4FuneTXthOF5aQW0aKnGWldFLsRghS7cy/8nvJ3CkfYK+LpT5jW8YRsh9cI1SqjQLcKXTWedTHVfKdns8vzmTTHuToqjj+GBvgHeUoBMDx0DgrYh+z3cOsK07S9z5RY4BTO89x0dFHm/vaKCBkVfGpGdU7XM+yeswHtmXIS95K9qQVYBAzC+V6PYCOqtthXHM+28eZHC2uv5zhOwLfKavQ2aZQBFKFO0E7manbt8PiS/vel2DmVdH61kg9V/rW5sl6aVE89yidI7PkgefG7wPqmgA97YV0xduzSC498Gy6Yzm51/ORpFJ+lGdYkjVgtyMhq1InnF19rmAxSnqL58iO7fsoavDtXBNwPWREgDMG05y49NVyF69L0ygnU8TZ34HseGIxN8RldbMoAXNc5zQ7GFGrE7LETSOWDEh2gN1Rn3e5XqZqRxDak2cSqX6B53IfgrG4M4yb2sEGHBGfX8e6O7DwP1RUswCK/+8= mfrank@x1
- name: mfrank
  gecos: Michael Frank
  primary_group: mfrank
  shell: /bin/bash
  sudo: ALL=(ALL) NOPASSWD:ALL
  groups: adm, dialout, cdrom, floppy, sudo, audio, dip, video, plugdev, netdev, lxd
  chpasswd: {expire: False}
  lock_passwd: false
  passwd: $6$rounds=4096$tBp/nksZ$9L5H/OAVhPKpeYBe4nEAIak1pxS/lik0GelMMTaIj8fvpvP/04ft.pNodOJ4IvK3DteN/npXO5AX00QBlmGpt1
  ssh_import_id: None
  ssh_pwauth: true
  ssh_authorized_keys:
    - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCdpdysJeBIVxdWFTmH7VsHAD8MYY4FuneTXthOF5aQW0aKnGWldFLsRghS7cy/8nvJ3CkfYK+LpT5jW8YRsh9cI1SqjQLcKXTWedTHVfKdns8vzmTTHuToqjj+GBvgHeUoBMDx0DgrYh+z3cOsK07S9z5RY4BTO89x0dFHm/vaKCBkVfGpGdU7XM+yeswHtmXIS95K9qQVYBAzC+V6PYCOqtthXHM+28eZHC2uv5zhOwLfKavQ2aZQBFKFO0E7manbt8PiS/vel2DmVdH61kg9V/rW5sl6aVE89yidI7PkgefG7wPqmgA97YV0xduzSC498Gy6Yzm51/ORpFJ+lGdYkjVgtyMhq1InnF19rmAxSnqL58iO7fsoavDtXBNwPWREgDMG05y49NVyF69L0ygnU8TZ34HseGIxN8RldbMoAXNc5zQ7GFGrE7LETSOWDEh2gN1Rn3e5XqZqRxDak2cSqX6B53IfgrG4M4yb2sEGHBGfX8e6O7DwP1RUswCK/+8= mfrank@x1
power_state:
    delay: now
    mode: reboot
    message: reboot now
    timeout: 30
    condition: true
